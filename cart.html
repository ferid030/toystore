<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/jpeg" href="images/favicon.jpg">
    <title>S…ôb…ôt - Toys Market</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .cart-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .cart-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }

        .cart-details {
            flex: 1;
        }

        .cart-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkout-section {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            margin-top: 2rem;
        }
    </style>
</head>

<body>
    <div id="app"></div>

    <div class="container mt-2 fade-in">
        <h1>S…ôb…ôtiniz</h1>
        <div id="cart-items"></div>

        <div id="cart-summary" class="checkout-section" style="display:none;">
            <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                <h3>C…ômi:</h3>
                <h3 id="total-price">0 AZN</h3>
            </div>

            <div id="payment-methods">
                <h4>√ñd…ôni≈ü n√∂v√ºn√º se√ßin:</h4>
                <div style="display:flex; gap:1rem; margin:1rem 0;">
                    <button class="btn btn-outline" onclick="showPayment('card')">Kart il…ô</button>
                    <button class="btn btn-outline" onclick="showPayment('tocoin')">Tocoin il…ô</button>
                </div>
            </div>

            <div id="card-payment" style="display:none;">
                <div class="alert" style="background:#e3f2fd; padding:1rem; border-radius:8px; margin-bottom:1rem;">
                    <p><strong>Kart n√∂mr…ôsi:</strong> 4169738847503707 (Kapital Bank)</p>
                    <p>√ñd…ôni≈üi etdikd…ôn sonra q…ôbzin ≈ü…ôklini y√ºkl…ôyin.</p>
                </div>
                <input type="file" id="receipt-upload" accept="image/*" class="mb-1">
                <button class="btn btn-primary" onclick="proceedToLocation('card')">Davam et</button>
            </div>

            <div id="tocoin-payment" style="display:none;">
                <p class="mb-1">Balansƒ±nƒ±z: <span id="user-balance">0</span> Tocoin</p>
                <p class="mb-1">T…ôl…ôb olunan: <span id="required-tocoin">0</span> Tocoin</p>
                <button class="btn btn-secondary" onclick="proceedToLocation('tocoin')">Davam et</button>
                <div id="balance-error" style="color:red; display:none; margin-top:0.5rem;">
                    Balansƒ±nƒ±z kifay…ôt etmir. <a href="/profile.html">Balansƒ± artƒ±r</a>
                </div>
            </div>

            <div id="delivery-location" style="display:none; margin-top:2rem;">
                <h4>üìç √áatdƒ±rƒ±lma √únvanƒ±</h4>
                <p style="color:#666; margin-bottom:1rem;">X…ôrit…ôd…ô √ßatdƒ±rƒ±lma √ºnvanƒ±nƒ± se√ßin (marker-i s√ºr√º≈üd√ºr√ºn v…ô ya
                    x…ôrit…ôy…ô klikl…ôyin)</p>

                <div id="map" style="height:400px; border-radius:var(--radius-sm); margin-bottom:1rem;"></div>

                <div style="background:#f0f8ff; padding:1rem; border-radius:var(--radius-sm); margin-bottom:1rem;">
                    <p><strong>Se√ßilmi≈ü √ºnvan:</strong></p>
                    <p id="selected-address" style="color:#666;">X…ôrit…ô y√ºkl…ônir...</p>
                </div>

                <button class="btn btn-primary" onclick="completeOrder()" style="width:100%;">Sifari≈üi T…ôsdiql…ô</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { renderNavbar, Loader, Toast } from './js/components.js';
        import { getCurrentUser } from './js/auth.js';
        import { Cart } from './js/cart.js';
        import { processCardCheckout, processTocoinCheckout } from './js/checkout.js';

        let currentUser = null;
        let map, marker;
        let selectedLocation = null;
        let selectedPaymentMethod = null;

        async function init() {
            currentUser = await getCurrentUser();
            document.getElementById('app').appendChild(renderNavbar(currentUser));
            renderCart();
        }

        function renderCart() {
            const cart = Cart.get();
            const container = document.getElementById('cart-items');
            const summary = document.getElementById('cart-summary');

            if (cart.length === 0) {
                container.innerHTML = '<p>S…ôb…ôtiniz bo≈üdur.</p>';
                summary.style.display = 'none';
                return;
            }

            container.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <img src="${item.image_url || 'https://placehold.co/100'}" alt="${item.name}">
                    <div class="cart-details">
                        <h4>${item.name}</h4>
                        <p>${item.price_azn} AZN ${item.tocoin_price ? `/ ${item.tocoin_price} Tocoin` : ''}</p>
                    </div>
                    <div class="cart-actions">
                        <button onclick="updateQty('${item.id}', ${item.qty - 1})">-</button>
                        <span>${item.qty}</span>
                        <button onclick="updateQty('${item.id}', ${item.qty + 1})">+</button>
                        <button onclick="removeItem('${item.id}')" style="color:red; margin-left:1rem;">&times;</button>
                    </div>
                </div>
            `).join('');

            const total = cart.reduce((acc, item) => acc + (item.price_azn * item.qty), 0);
            document.getElementById('total-price').textContent = `${total.toFixed(2)} AZN`;
            summary.style.display = 'block';
        }

        window.updateQty = (id, qty) => {
            Cart.updateQty(id, qty);
            renderCart();
        };

        window.removeItem = (id) => {
            Cart.remove(id);
            renderCart();
        };

        window.showPayment = (method) => {
            document.getElementById('card-payment').style.display = method === 'card' ? 'block' : 'none';
            document.getElementById('tocoin-payment').style.display = method === 'tocoin' ? 'block' : 'none';

            if (method === 'tocoin') {
                const cart = Cart.get();
                const totalTocoin = cart.reduce((acc, item) => acc + ((item.tocoin_price || 0) * item.qty), 0);
                document.getElementById('user-balance').textContent = currentUser?.tocoin_balance || 0;
                document.getElementById('required-tocoin').textContent = totalTocoin;

                if (!currentUser || currentUser.tocoin_balance < totalTocoin) {
                    document.getElementById('balance-error').style.display = 'block';
                } else {
                    document.getElementById('balance-error').style.display = 'none';
                }
            }
        };

        window.proceedToLocation = (method) => {
            selectedPaymentMethod = method;

            if (method === 'card') {
                const fileInput = document.getElementById('receipt-upload');
                if (fileInput.files.length === 0) {
                    Toast.show('Z…ôhm…ôt olmasa q…ôbz ≈ü…ôklini y√ºkl…ôyin.', 'error');
                    return;
                }
            } else if (method === 'tocoin') {
                const cart = Cart.get();
                const totalTocoin = cart.reduce((acc, item) => acc + ((item.tocoin_price || 0) * item.qty), 0);
                if (!currentUser || currentUser.tocoin_balance < totalTocoin) {
                    Toast.show('Balansƒ±nƒ±z kifay…ôt etmir', 'error');
                    return;
                }
            }

            document.getElementById('payment-methods').style.display = 'none';
            document.getElementById('card-payment').style.display = 'none';
            document.getElementById('tocoin-payment').style.display = 'none';
            document.getElementById('delivery-location').style.display = 'block';

            setTimeout(() => initMap(), 100);
        };

        function initMap() {
            const baku = [40.4093, 49.8671];

            map = L.map('map').setView(baku, 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            marker = L.marker(baku, {
                draggable: true,
                title: '√áatdƒ±rƒ±lma √ºnvanƒ±'
            }).addTo(map);

            selectedLocation = { lat: baku[0], lng: baku[1] };

            marker.on('dragend', function (e) {
                const position = marker.getLatLng();
                selectedLocation = {
                    lat: position.lat,
                    lng: position.lng
                };
                getAddress(position.lat, position.lng);
            });

            map.on('click', function (e) {
                marker.setLatLng(e.latlng);
                selectedLocation = {
                    lat: e.latlng.lat,
                    lng: e.latlng.lng
                };
                getAddress(e.latlng.lat, e.latlng.lng);
            });

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const pos = [position.coords.latitude, position.coords.longitude];
                    map.setView(pos, 14);
                    marker.setLatLng(pos);
                    selectedLocation = { lat: pos[0], lng: pos[1] };
                    getAddress(pos[0], pos[1]);
                }, (error) => {
                    console.log('Geolocation error:', error);
                    getAddress(baku[0], baku[1]);
                });
            } else {
                getAddress(baku[0], baku[1]);
            }
        }

        function getAddress(lat, lng) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=az`)
                .then(response => response.json())
                .then(data => {
                    if (data.display_name) {
                        document.getElementById('selected-address').textContent = data.display_name;
                    } else {
                        document.getElementById('selected-address').textContent = `Koordinatlar: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    }
                })
                .catch((error) => {
                    console.error('Geocoding error:', error);
                    document.getElementById('selected-address').textContent = `Koordinatlar: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                });
        }

        window.completeOrder = async () => {
            if (!selectedLocation) {
                Toast.show('Z…ôhm…ôt olmasa √ßatdƒ±rƒ±lma √ºnvanƒ±nƒ± se√ßin', 'error');
                return;
            }

            Loader.show();

            if (selectedPaymentMethod === 'card') {
                const fileInput = document.getElementById('receipt-upload');
                await processCardCheckout(fileInput.files[0], selectedLocation);
            } else {
                await processTocoinCheckout(selectedLocation);
            }
        };

        init();
    </script>
</body>

</html>