<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/jpeg" href="images/favicon.jpg">
    <title>S…ôb…ôt - Toys Market</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/home.css">
    <link rel="stylesheet" href="css/modern.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .cart-container {
            max-width: 1000px;
            margin: 40px auto;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            padding: 0 20px;
        }

        @media (max-width: 991px) {
            .cart-container {
                grid-template-columns: 1fr;
            }
        }

        .cart-items-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .cart-card {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
        }

        .cart-card img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: var(--radius-md);
        }

        .cart-info {
            flex: 1;
        }

        .cart-info h4 {
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .cart-info p {
            color: var(--primary-color);
            font-weight: 700;
        }

        .qty-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: var(--radius-sm);
        }

        .qty-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--secondary-color);
            cursor: pointer;
        }

        .remove-btn {
            color: var(--danger-color);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 10px;
        }

        .summary-card {
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        #map {
            height: 350px;
            border-radius: var(--radius-md);
            margin: 20px 0;
            box-shadow: var(--shadow-sm);
        }

        .payment-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #edeff2;
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .payment-option.active {
            border-color: var(--primary-color);
            background: rgba(255, 71, 87, 0.05);
        }
    </style>
</head>

<body>
    <div id="preloader">
        <div class="loader-toy">üõí</div>
    </div>

    <div id="app"></div>

    <header class="page-header">
        <div class="container">
            <h1>Alƒ±≈ü-Veri≈ü S…ôb…ôti üõçÔ∏è</h1>
            <p>Se√ßdiyiniz m√∂ht…ô≈ü…ôm oyuncaqlar buradadƒ±r.</p>
        </div>
    </header>

    <main class="cart-container">
        <div class="cart-items-list reveal" id="cart-items">
            <!-- Items injected here -->
        </div>

        <div class="summary-card glass-card reveal" style="transition-delay: 200ms;" id="cart-summary">
            <h3 style="margin-bottom: 20px;">Sifari≈ü X√ºlas…ôsi</h3>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>M…ôhsul sayƒ±:</span>
                <span id="items-count">0</span>
            </div>
            <div
                style="display: flex; justify-content: space-between; margin-bottom: 25px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);">
                <span style="font-weight: 800; font-size: 1.2rem;">C…ômi:</span>
                <span id="total-price" style="font-weight: 800; font-size: 1.2rem; color: var(--primary-color);">0
                    AZN</span>
            </div>

            <div id="checkout-flow-1">
                <p style="margin-bottom: 15px; font-weight: 600;">√ñd…ôni≈ü Metodu Se√ßin:</p>
                <div style="display: flex; gap: 10px; margin-bottom: 25px;">
                    <div class="payment-option" id="pay-card" onclick="selectPayment('card')">
                        <span style="display: block; font-size: 1.5rem;">üí≥</span>
                        <span style="font-size: 0.8rem; font-weight: 700;">Kart il…ô</span>
                    </div>
                    <div class="payment-option" id="pay-tocoin" onclick="selectPayment('tocoin')">
                        <span style="display: block; font-size: 1.5rem;">üí∞</span>
                        <span style="font-size: 0.8rem; font-weight: 700;">Tocoin</span>
                    </div>
                </div>

                <div id="card-info" style="display:none; margin-bottom: 20px;">
                    <div
                        style="background: #e3f2fd; padding: 15px; border-radius: var(--radius-md); font-size: 0.85rem; margin-bottom: 15px;">
                        <p><strong>Kapital Bank:</strong> 4169738847503707</p>
                        <p style="margin-top: 5px; opacity: 0.7;">√ñd…ôni≈ü edib q…ôbzi bura y√ºkl…ôyin.</p>
                    </div>
                    <input type="file" id="receipt-upload" class="form-control" accept="image/*">
                </div>

                <div id="tocoin-info" style="display:none; margin-bottom: 20px;">
                    <div
                        style="background: #fff3e0; padding: 15px; border-radius: var(--radius-md); font-size: 0.85rem;">
                        <p>Balans: <strong id="user-balance">0 TC</strong></p>
                        <p>T…ôl…ôb olunan: <strong id="required-tocoin">0 TC</strong></p>
                    </div>
                    <div id="balance-error"
                        style="color:var(--danger-color); font-size: 0.8rem; margin-top: 10px; display: none;">
                        X…ôta: Balansƒ±nƒ±z kifay…ôt etmir!
                    </div>
                </div>

                <button class="btn btn-primary" onclick="proceedToLocation()" style="width: 100%;">Davam Et ‚û°Ô∏è</button>
            </div>

            <div id="checkout-flow-2" style="display: none;">
                <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span>üìç</span> √áatdƒ±rƒ±lma √únvanƒ±
                </h4>

                <!-- Search Bar -->
                <div style="position: relative; margin-bottom: 15px;">
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="map-search" class="form-control"
                            placeholder="√únvanƒ± axtarƒ±n (m…ôs: Nizami k√º√ß)..." style="font-size: 0.9rem;">
                        <button class="btn btn-primary" onclick="searchLocation()"
                            style="padding: 0 20px; min-width: auto; height: 46px;">üîç</button>
                    </div>
                    <div id="search-results"
                        style="display:none; position:absolute; top:100%; left:0; right:0; background:white; z-index:1001; border-radius:10px; box-shadow:var(--shadow-lg); max-height:200px; overflow-y:auto; margin-top:5px; border: 1px solid #eee;">
                    </div>
                </div>

                <div style="position: relative;">
                    <div id="map"></div>
                    <button onclick="detectLocation()" title="M…ônim yerim"
                        style="position: absolute; bottom: 20px; right: 10px; z-index: 1000; background: white; border: none; width: 40px; height: 40px; border-radius: 8px; box-shadow: var(--shadow-md); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">üì°</button>
                </div>

                <div
                    style="background: var(--bg-main); padding: 15px; border-radius: var(--radius-md); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.05);">
                    <p style="font-size: 0.85rem; font-weight: 700; color: var(--secondary-color); margin-bottom: 5px;">
                        Se√ßilmi≈ü √únvan:</p>
                    <p id="selected-address" style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4;">
                        X…ôrit…ô y√ºkl…ônir...
                    </p>
                </div>
                <button class="btn btn-primary" onclick="completeOrder()"
                    style="width: 100%; height: 55px; font-size: 1.1rem;">Sifari≈üi Tamamla ‚úÖ</button>
                <button class="btn" onclick="goBack()" style="width: 100%; margin-top: 10px; font-size: 0.85rem;">Geri
                    Qayƒ±t</button>
            </div>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { supabase } from './js/supabase.js';
        import { renderNavbar, renderFooter, Loader, Toast } from './js/components.js';
        import { getCurrentUser } from './js/auth.js';
        import { Cart } from './js/cart.js';
        import { processCardCheckout, processTocoinCheckout } from './js/checkout.js';
        import { reveal, initPreloader } from './js/animations.js';

        let currentUser = null;
        let map, marker;
        let selectedLocation = null;
        let selectedPaymentMethod = null;

        async function init() {
            initPreloader();
            currentUser = await getCurrentUser();
            document.getElementById('app').appendChild(renderNavbar(currentUser));
            document.body.appendChild(renderFooter());
            renderCart();
            reveal();
        }

        function renderCart() {
            const cart = Cart.get();
            const container = document.getElementById('cart-items');
            const summary = document.getElementById('cart-summary');

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="glass-card text-center" style="padding: 60px;">
                        <span style="font-size: 4rem;">üõí</span>
                        <h2 style="margin-top: 20px;">S…ôb…ôtiniz h…ôl…ô ki bo≈üdur.</h2>
                        <a href="/index.html" class="btn btn-primary" style="margin-top: 20px;">Alƒ±≈ü-veri≈ü…ô davam et</a>
                    </div>
                `;
                summary.style.display = 'none';
                return;
            }

            container.innerHTML = cart.map(item => `
                <div class="glass-card cart-card reveal">
                    <img src="${item.image_url || 'https://placehold.co/100'}" alt="${item.name}">
                    <div class="cart-info">
                        <h4>${item.name}</h4>
                        <p>${item.price_azn} AZN</p>
                        ${item.tocoin_price ? `<span style="font-size: 0.8rem; color: #ffa502; font-weight: 700;">üí∞ ${item.tocoin_price} TC</span>` : ''}
                    </div>
                    <div class="qty-controls">
                        <button class="qty-btn" onclick="updateQty('${item.id}', ${item.qty - 1})">‚àí</button>
                        <span style="font-weight: 800; font-size: 1.1rem; min-width: 25px; text-align: center;">${item.qty}</span>
                        <button class="qty-btn" onclick="updateQty('${item.id}', ${item.qty + 1})">+</button>
                    </div>
                    <button class="remove-btn" onclick="removeItem('${item.id}')" title="Sil">üóëÔ∏è</button>
                </div>
            `).join('');

            const total = cart.reduce((acc, item) => acc + (item.price_azn * item.qty), 0);
            const count = cart.reduce((acc, item) => acc + item.qty, 0);

            document.getElementById('items-count').textContent = count;
            document.getElementById('total-price').textContent = `${total.toFixed(2)} AZN`;
            summary.style.display = 'block';
            reveal();
        }

        window.updateQty = (id, qty) => {
            Cart.updateQty(id, qty);
            renderCart();
        };

        window.removeItem = (id) => {
            Cart.remove(id);
            renderCart();
        };

        window.selectPayment = (method) => {
            selectedPaymentMethod = method;
            document.getElementById('pay-card').classList.toggle('active', method === 'card');
            document.getElementById('pay-tocoin').classList.toggle('active', method === 'tocoin');

            document.getElementById('card-info').style.display = method === 'card' ? 'block' : 'none';
            document.getElementById('tocoin-info').style.display = method === 'tocoin' ? 'block' : 'none';

            if (method === 'tocoin') {
                const cart = Cart.get();
                const totalTocoin = cart.reduce((acc, item) => acc + ((item.tocoin_price || 0) * item.qty), 0);
                document.getElementById('user-balance').textContent = `${currentUser?.tocoin_balance || 0} TC`;
                document.getElementById('required-tocoin').textContent = `${totalTocoin} TC`;

                if (!currentUser || currentUser.tocoin_balance < totalTocoin) {
                    document.getElementById('balance-error').style.display = 'block';
                } else {
                    document.getElementById('balance-error').style.display = 'none';
                }
            }
        };

        window.proceedToLocation = () => {
            if (!selectedPaymentMethod) {
                Toast.show('Z…ôhm…ôt olmasa √∂d…ôni≈ü metodu se√ßin.', 'error');
                return;
            }

            if (selectedPaymentMethod === 'card') {
                const fileInput = document.getElementById('receipt-upload');
                if (fileInput.files.length === 0) {
                    Toast.show('√ñd…ôm…ô q…ôbzini y√ºkl…ôm…ôlisiniz.', 'error');
                    return;
                }
            } else {
                const cart = Cart.get();
                const totalTocoin = cart.reduce((acc, item) => acc + ((item.tocoin_price || 0) * item.qty), 0);
                if (!currentUser || currentUser.tocoin_balance < totalTocoin) {
                    Toast.show('Balansƒ±nƒ±zda kifay…ôt q…ôd…ôr Tocoin yoxdur.', 'error');
                    return;
                }
            }

            document.getElementById('checkout-flow-1').style.display = 'none';
            document.getElementById('checkout-flow-2').style.display = 'block';

            setTimeout(() => {
                initMap();
                const searchInput = document.getElementById('map-search');
                if (searchInput) {
                    searchInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') searchLocation();
                    });
                }
            }, 300);
        };

        window.goBack = () => {
            document.getElementById('checkout-flow-2').style.display = 'none';
            document.getElementById('checkout-flow-1').style.display = 'block';
        };

        function initMap() {
            const baku = [40.4093, 49.8671];
            if (!map) {
                map = L.map('map', { zoomControl: false }).setView(baku, 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

                // Red custom icon for marker
                const icon = L.divIcon({
                    html: 'üìç',
                    className: 'custom-div-icon',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                });

                marker = L.marker(baku, { draggable: true, icon: icon }).addTo(map);
                selectedLocation = { lat: baku[0], lng: baku[1] };

                marker.on('dragend', () => {
                    const pos = marker.getLatLng();
                    updateSelectedLocation(pos.lat, pos.lng);
                });

                map.on('click', (e) => {
                    marker.setLatLng(e.latlng);
                    updateSelectedLocation(e.latlng.lat, e.latlng.lng);
                });

                // Auto-detect on start
                detectLocation();
            } else {
                map.invalidateSize();
            }
        }

        window.detectLocation = () => {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const { latitude, longitude } = position.coords;
                    const pos = [latitude, longitude];
                    map.setView(pos, 16);
                    marker.setLatLng(pos);
                    updateSelectedLocation(latitude, longitude);
                }, () => {
                    Toast.show('M…ôkanƒ±nƒ±zƒ± tapa bilm…ôdik. Bakƒ± m…ôrk…ôz se√ßildi.', 'info');
                });
            }
        };

        window.searchLocation = async () => {
            const query = document.getElementById('map-search').value;
            if (!query) return;

            Loader.show();
            try {
                const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                const data = await r.json();
                if (data.length > 0) {
                    const { lat, lon } = data[0];
                    const pos = [parseFloat(lat), parseFloat(lon)];
                    map.setView(pos, 16);
                    marker.setLatLng(pos);
                    updateSelectedLocation(lat, lon);
                } else {
                    Toast.show('√únvan tapƒ±lmadƒ±.', 'error');
                }
            } catch (e) {
                Toast.show('Axtarƒ±≈üda x…ôta ba≈ü verdi.', 'error');
            } finally {
                Loader.hide();
            }
        };

        function updateSelectedLocation(lat, lng) {
            selectedLocation = { lat, lng };
            getAddress(lat, lng);
        }

        function getAddress(lat, lng) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=az`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('selected-address').textContent = data.display_name || `${lat}, ${lng}`;
                })
                .catch(() => {
                    document.getElementById('selected-address').textContent = `${lat}, ${lng}`;
                });
        }

        window.completeOrder = async () => {
            Loader.show();
            if (selectedPaymentMethod === 'card') {
                const fileInput = document.getElementById('receipt-upload');
                await processCardCheckout(fileInput.files[0], selectedLocation);
            } else {
                await processTocoinCheckout(selectedLocation);
            }
        };

        init();
    </script>
</body>

</html>