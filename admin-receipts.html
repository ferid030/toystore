<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/jpeg" href="images/favicon.jpg">
    <title>Q…ôbzl…ôr - Admin Panel</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/home.css">
    <link rel="stylesheet" href="css/modern.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .admin-receipt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .receipt-card {
            padding: 0;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .receipt-thumb {
            width: 100%;
            height: 200px;
            object-fit: cover;
            cursor: pointer;
            transition: var(--transition);
        }

        .receipt-thumb:hover {
            transform: scale(1.02);
        }

        .receipt-details {
            padding: 20px;
        }

        .receipt-user {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .receipt-amount {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-color);
        }

        .receipt-date {
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <div id="preloader">
        <div class="loader-toy">üßæ</div>
    </div>

    <div class="admin-layout">
        <aside class="admin-sidebar">
            <h2>Toys Market</h2>
            <nav class="admin-nav">
                <a href="admin.html"><span>üìä</span> <span>Dashboard</span></a>
                <a href="admin-toys.html"><span>üß∏</span> <span>Oyuncaqlar</span></a>
                <a href="admin-receipts.html" class="active"><span>üßæ</span> <span>Q…ôbzl…ôr</span></a>
                <a href="admin-users.html"><span>üë•</span> <span>ƒ∞stifad…ô√ßil…ôr</span></a>
                <a href="admin-orders.html"><span>üì¶</span> <span>Sifari≈ül…ôr</span></a>
                <hr style="opacity: 0.1; margin: 10px 0;">
                <a href="/"><span>üè†</span> <span>Sayta Qayƒ±t</span></a>
            </nav>
        </aside>

        <main class="admin-main">
            <header class="admin-header reveal">
                <div>
                    <h1 style="font-size: 2rem; font-weight: 800;">Q…ôbzl…ôrin T…ôsdiql…ônm…ôsi üßæ</h1>
                    <p style="color: var(--text-muted);">ƒ∞stifad…ô√ßil…ôrin y√ºkl…ôdiyi √∂d…ôni≈ü q…ôbzl…ôrini yoxlayƒ±n.</p>
                </div>
            </header>

            <div id="receipts-container" class="admin-receipt-grid reveal">
                <!-- Data goes here -->
            </div>
        </main>
    </div>

    <!-- Image Modal -->
    <div id="img-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; justify-content:center; align-items:center; cursor:pointer;"
        onclick="this.style.display='none'">
        <img id="modal-img" src=""
            style="max-width:90%; max-height:90%; object-fit:contain; border-radius:15px; box-shadow: 0 0 50px rgba(0,0,0,0.5);">
    </div>

    <script type="module">
        import { supabase } from './js/supabase.js';
        import { checkAdmin, AdminReceipts } from './js/admin.js';
        import { reveal, initPreloader } from './js/animations.js';

        async function init() {
            initPreloader();
            await checkAdmin();
            await loadReceipts();
            window.addEventListener('scroll', reveal);
            reveal();
        }

        async function loadReceipts() {
            const { data: receipts } = await supabase
                .from('receipts')
                .select('*, users(email, full_name)')
                .eq('status', 'waiting')
                .order('created_at', { ascending: false });

            const container = document.getElementById('receipts-container');

            if (!receipts || receipts.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding: 100px; opacity: 0.5;"><h3>Hazƒ±rda g√∂zl…ôy…ôn q…ôbz yoxdur. ‚ú®</h3></div>';
                return;
            }

            const receiptsWithUrls = await Promise.all(receipts.map(async (r) => {
                const { data } = await supabase.storage.from('receipts').createSignedUrl(r.image_url, 3600);
                return { ...r, signedUrl: data?.signedUrl };
            }));

            container.innerHTML = receiptsWithUrls.map((r, idx) => `
                <div class="glass-card receipt-card reveal" style="transition-delay: ${idx * 100}ms;">
                    <img src="${r.signedUrl}" class="receipt-thumb" onclick="openFullImage('${r.signedUrl}')">
                    <div class="receipt-details">
                        <div class="receipt-user">${r.users?.full_name || 'Nam…ôlum'}</div>
                        <div style="font-size: 0.75rem; color: #777; margin-bottom: 10px;">${r.users?.email}</div>
                        <div class="receipt-amount">${r.amount_azn} AZN</div>
                        <div class="receipt-date">üïí ${new Date(r.created_at).toLocaleString('az-AZ')}</div>
                        <div style="display:flex; gap:10px;">
                            <button onclick="approveReceipt('${r.id}', '${r.user_id}', ${r.amount_azn})" class="btn btn-primary" style="flex:1; padding: 8px;">T…ôsdiql…ô</button>
                            <button onclick="rejectReceipt('${r.id}')" class="btn btn-outline" style="flex:1; padding: 8px; color: var(--danger-color);">ƒ∞mtina</button>
                        </div>
                    </div>
                </div>
            `).join('');

            window.openFullImage = (url) => {
                document.getElementById('modal-img').src = url;
                document.getElementById('img-modal').style.display = 'flex';
            };

            window.approveReceipt = (id, userId, amountAzn) => {
                const amount = prompt('ƒ∞stifad…ô√ßiy…ô k√∂√ß√ºr√ºl…ôc…ôk Tocoin miqdarƒ±:', amountAzn);
                if (amount) {
                    AdminReceipts.approve(id, userId, amount);
                    setTimeout(loadReceipts, 1000);
                }
            };

            window.rejectReceipt = (id) => {
                const reason = prompt('ƒ∞mtina s…ôb…ôbi:', 'Q…ôbz aydƒ±n oxunmur');
                if (reason) {
                    AdminReceipts.reject(id, reason);
                    setTimeout(loadReceipts, 1000);
                }
            };
        }

        init();
    </script>
</body>

</html>